\chapter{Decyzje projektowe}
\label{chap:3}
Na pocz¹tku rozdzia³u dokonano porównania miêdzy koncepcj¹ pierwotn¹, a finaln¹ architektury systemu. W kolejnych podrozdzia³ach zawarto uzasadnienie decyzji projektowych finalnej struktury systemu oraz wyjaœniono podstawy technologii wybranych do realizacji poszczególnych zadañ. Praktyczne implementacje nie s¹ zawarte w tym rozdziale --- jest to treœæ rozdzia³u~\ref{chap:5}

\section{Architektura systemu}
Pierwotna koncepcja zak³ada³a zaprojektowanie i implementacjê dwóch osobnych aplikacji pod wspóln¹ nazw¹. Pierwsz¹ z nich mia³a byæ aplikacja internetowa (dostêp poprzez przegl¹darkê). W niej zawarte mia³y byæ wszystkie planowane funkcjonalnoœci za wyj¹tkiem jedynie nagrywania œladów z wykorzystaniem modu³u GPS. Za to zadanie mia³a byæ odpowiedzialna dedykowana aplikacja mobilna dla systemu \texttt{Android}. Ta wizja jednak uleg³a zmianie --- finalna wersja zak³ada wykonanie aplikacji internetowej w technice PWA. Pozwala ona na instalacjê aplikacji internetowej na urz¹dzeniu mobilnym i sprawienie wra¿enia aplikacji natywnej. Takie rozwi¹zanie posiada zarówno swoje zalety, jak i wady. Do korzyœci na pewno nale¿¹:
\begin{enumerate}
  \item Jedna aplikacja oznacza jedn¹ bazê kodu, któr¹ ³atwiej jest utrzymaæ i rozwijaæ w stosunku do dwóch osobnych baz.
  \item Funkcjonalnoœci aplikacji mobilnej i internetowej s¹ identyczne.
  \item Aplikacja mobilna nie jest ograniczona do dzia³ania jedynie na systemie \texttt{Android}.
  \item Brak koniecznoœci rozprowadzania pakietu instalacyjnego aplikacji mobilnej.
\end{enumerate}
G³ównym problemem natomiast mo¿e okazaæ siê wydajnoœæ takiego rozwi¹zania. Dzia³anie PWA oparte jest na przegl¹darce internetowej. Z kolei aplikacje natywne dzia³aj¹ w systemie jako niezale¿ne instancje. W ogólnym ujêciu aplikacje natywne pozwalaj¹ na uzyskanie lepszej wydajnoœci, poniewa¿ maj¹ bezpoœredni dostêp do zasobów sprzêtowych.

Porównanie koncepcji oraz dobór technologii realizacji poszczególnych modu³ów systemu zestawiono w tabeli~\ref{tab:koncepcje}. Wyjaœnienie oraz uzasadnienie tych wyborów zawarto w kolejnych podrozdzia³ach.

\begin{table}[htb] \small
  \centering
  \caption{Porównanie koncepcji architektury systemu i dobór technologii}
  \label{tab:koncepcje}
  \begin{tabularx}{\linewidth}{|l|l|X|} \hline
    Zadanie               & Koncept pierwotny                                          & Koncept finalny            \\ \hline\hline
    Aplikacja internetowa & \texttt{React}                                             & \texttt{React (PWA)}       \\ \hline
    Aplikacja mobilna     & \texttt{React Native}                                      & \texttt{React (PWA)}       \\ \hline
    Backend               & \texttt{Firebase}                                          & \texttt{Firebase}          \\ \hline
    Baza danych           & \texttt{Firebase Firestore} lub \texttt{Realtime Database} & \texttt{Realtime Database} \\ \hline
    Hosting               & \texttt{Firebase Hosting}                                  & \texttt{Firebase Hosting}  \\ \hline
  \end{tabularx}
\end{table}

\section{Warstwa backend}
W tradycyjnym podejœciu tworzenia aplikacji internetowej lub mobilnej, poza wykonaniem oprogramowania klienckiego, zazwyczaj konieczne jest utworzenie serwera, bazy danych, magazynu plików, systemu uwierzytelniania oraz po³¹czenie tych (i wielu innych) elementów w dzia³aj¹c¹ ca³oœæ.

Alternatyw¹ jest wykorzystanie modelu BaaS (ang.~\emph{Backend-as-a-Service}), który przenosi odpowiedzialnoœæ za funkcje backendowe na dostawcê BaaS. Poszczególne modu³y (np.:~baza danych czy system uwierzytelniania) do³¹czane s¹ do warstwy klienta z u¿yciem pakietów SDK (ang.~\emph{Software Development Kit}) oraz API (ang.~\emph{Application Programming Interface}). Obrazowo mo¿na przedstawiæ to tak: programista buduje system z gotowych, dostarczonych z zewn¹trz, konfigurowalnych klocków, zamiast tworzyæ swoje w³asne klocki od podstaw. Dziêki temu rozwój oprogramowania jest szybszy, tañszy, oraz mniej podatny na b³êdy, a samo oprogramowanie jest ³atwo skalowalne. Jednak w przypadku zapotrzebowania na unikalne funkcjonalnoœci warstwy backend, BaaS mo¿e siê nie sprawdziæ ze wzglêdu na ograniczone mo¿liwoœci~konfiguracyjne.

BaaS jest technologi¹ stosunkowo now¹, poniewa¿ pierwsze projekty w tej dziedzinie siêgaj¹ zaledwie pocz¹tku drugiej dekady XX wieku. Obecnie na rynku dostêpnych jest wiele platform. Do najpopularniejszych mo¿na zaliczyæ (kolejnoœæ losowa): \texttt{Google Firebase}, \texttt{Apple CloudKit}, \texttt{Amazon AWS Amplify}, \texttt{Microsoft Azure Mobile Apps}, \texttt{Back4App}, \texttt{Parse} czy \texttt{Backendless}. Czêœæ z nich jest jest oprogramowaniem otwartym. Platformy komercyjne udostêpniaj¹ swoje us³ugi w chmurze, w ramach darmowych oraz p³atnych planów (np.:~\texttt{Firebase}, \texttt{AWS Amplify}). Niektóre platformy wymagaj¹ w³asnego hostowania (np.:~\texttt{Parse}).

Ca³a warstwa backend realizowanego projektu oparta jest na platformie \texttt{Google Firebase}. W jej zakres wchodz¹ modu³y, które przedstawiono w tabeli~\ref{tab:firebase}. Szczegó³y mo¿na znaleŸæ w dokumentacji technicznej \cite{firebase}. G³ówne powody wybrania akurat tej platformy s¹ nastêpuj¹ce:
\begin{itemize}
  \item Podstawowe doœwiadczenie autora w integracji z platform¹, wynikaj¹ce z wykorzystania jej we wczeœniej realizowanych projektach.
  \item Dostêpnoœæ platformy w chmurze (brak koniecznoœci samodzielnego hostowania backendu).
  \item Dostêpnoœæ darmowego planu, pokrywaj¹cego zapotrzebowanie w ramach rozwoju i testowania tworzonego oprogramowania.
  \item Pokrycie wszystkich wymagañ projektu przez udostêpniane us³ugi.
\end{itemize}

\begin{table}[htb] \small
  \centering
  \caption{Lista bibliotek wykorzystanych przy implementacji aplikacji klienta}
  \label{tab:firebase}
  \begin{tabularx}{\linewidth}{|l|X|} \hline
    Modu³                       & Opis                                                                                                                                                                                              \\ \hline\hline
    \texttt{Authentication}     & System uwierzytelniania (email i has³o, \emph{identity provider}, numer telefonu, \emph{custom}, sesja anonimowa). \texttt{FirebaseUI} --- gotowe rozwi¹zanie uwierzytelniania w warstwie klienta \\ \hline
    \texttt{Realtime Database}  & Baza danych NoSQL (baza JSON)                                                                                                                                                                     \\ \hline
    \texttt{Firestore Database} & Baza danych NoSQL (baza dokumentowa)                                                                                                                                                              \\ \hline
    \texttt{Cloud Storage}      & Przestrzeñ do przechowywania plików                                                                                                                                                               \\ \hline
    \texttt{Machine Learning}   & Dostêp do wyuczonych modeli oraz mo¿liwoœæ szkolenia w³asnych modeli w chmurze lub na urz¹dzeniu u¿ytkownika                                                                                      \\ \hline
    \texttt{Hosting}            & Hosting aplikacji internetowych, statycznej i dynamicznej zawartoœci oraz mikroserwisów w sieci                                                                                                   \\ \hline
    \texttt{Cloud Functions}    & Framework umo¿liwiaj¹cy wykonanie zadanego kodu po stronie backendu w odpowiedzi na zdarzenie lub zapytanie HTTPS.                                                                                \\ \hline
  \end{tabularx}
\end{table}

W ramach projektu wykorzystane zosta³y modu³y: \texttt{Authentication}, \texttt{Realtime Database}, \texttt{Hosting}. W kolejnych podrozdzia³ach opisano  zwi¹zane z nimi za³o¿enia.

\subsection{Uwierzytelnianie}
Implementacja w³asnego systemu uwierzytelniana jest procesem z³o¿onym, pracoch³onnym i wymagaj¹cym odpowiedniej wiedzy. Dlatego Firebase dostarcza modu³ Authentication odpowiedzialny za obs³ugê uwierzytelniania. Udostêpnia on cztery metody, którymi u¿ytkownik mo¿e potwierdziæ swoj¹ to¿samoœæ:
\begin{enumerate}
  \item Z u¿yciem emaila i has³a.
  \item Z u¿yciem numeru telefonu.
  \item Poprzez zewnêtrznego dostawcê: \texttt{Google}, \texttt{Facebook}, \texttt{Play Games}, \texttt{Game Center}, \texttt{Apple}, \texttt{GitHub}, \texttt{Microsoft}, \texttt{Twitter}, \texttt{Yahoo}.
  \item Sesja anonimowa.
\end{enumerate}

Bazowa wersja projektu zak³ada wykorzystanie dwóch z powy¿szych metod: email i has³o oraz jeden zewnêtrzny dostawca --- \texttt{Google}. Natomiast wraz z rozwojem aplikacji przewidziane jest rozszerzenie listy zewnêtrznych dostawców oraz dodanie uwierzytelniania z wykorzystaniem numeru telefonu. Nie nale¿y to jednak do zadañ priorytetowych projektu.

Firebase dostarcza równie¿ bibliotekê \texttt{FirebaseUI}, która posiada zaimplementowany interfejs u¿ytkownika oraz wiêkszoœæ logiki programowej wymaganej do uwierzytelnienia po stronie klienta. Interfejs ten osadza siê w aplikacji i konfiguruje wed³ug w³asnych preferencji. W projekcie wykorzystano tê bibliotekê.

\subsection{Baza danych}
\texttt{Firebase} oferuje dwa rodzaje baz danych hostowanych w chmurze: \texttt{Realtime Database} i \texttt{Firestore Database}. S¹ to bazy typu \emph{real-time} (nie myliæ z nazw¹ samej bazy danych), co oznacza ¿e s¹ one w stanie wydajnie przetwarzaæ dane w czasie rzeczywistym. Z ka¿d¹ zmian¹ danych w bazie, wszystkie aktywne, pod³¹czone urz¹dzenia otrzymuj¹ natychmiastow¹ aktualizacjê. Ponadto systemy te zaprojektowane s¹ w taki sposób, ¿e gdy urz¹dzenie utraci po³¹czenie z Internetem, aplikacja mo¿e pracowaæ dalej. Jest to mo¿liwe dziêki zachowaniu lokalnej kopii ostatnio u¿ywanych danych (\emph{data persistence}). Wszystkie wykonane operacje offline s¹ synchronizowane z baz¹ po odzyskaniu po³¹czenia, a powsta³e konflikty s¹ rozstrzygane automatycznie. Obydwie bazy s¹ bazami nierelacyjnymi (NoSQL) --- \texttt{Realtime} oparty jest na obiekcie JSON, natomiast \texttt{Firestore} to baza dokumentowa. \texttt{Firestore} jest rozwi¹zaniem nowszym, bazuj¹cym poniek¹d na \texttt{Realtime}, jednak nie oznacza to, ¿e \texttt{Realtime} jest bezu¿yteczny. Oba rozwi¹zania znajduj¹ swoje zastosowania w ró¿nych przypadkach. Na potrzeby projektu, jako bazê danych wybrano \texttt{Realtime Database}, poniewa¿ jest prostsza w obs³udze wzglêdem \texttt{Firestore'a}, natomiast jej mo¿liwoœci wci¹¿ pokrywaj¹ wymagania.


Schemat struktury obiektu JSON stanowi¹cego bazê danych przedstawia pseudokod zawarty na listingu~\ref{lst:database}. Na schemacie podane zosta³y typu poszczególnych pól. Znak~\texttt{?} przy nazwie pola sugeruje, ¿e pole to mo¿e przyj¹æ wartoœæ \texttt{null}. Wpis \texttt{<unique(userId)>} nale¿y rozumieæ, ¿e w obrêbie obiektu \texttt{database\_root} mo¿e wyst¹piæ wiele obiektów, których nazwy s¹ unikalne. Typy \texttt{GENDERS}, \texttt{RATINGS}, \texttt{SPORTS}, \texttt{CATEGORIES} pe³ni¹ w schemacie rolê tylko pomocnicz¹ i s¹ wykorzystane na dwa ró¿ne sposoby: \texttt{valueOf(\emph{TYPE})} --- oznacza, ¿e pole przyjmuje jedn¹ wartoœæ z danego \emph{TYPE}; \texttt{<valueOf(\emph{TYPE})>} --- oznacza, ¿e wszystkie wartoœci danego typu s¹~wykorzystane.

{\belowcaptionskip=-9pt
\begin{lstlisting}[language=JavaScript, label=lst:database, caption=Pseudkod przedstawiaj¹cy strukturê zastosowanej bazy danych,
    basicstyle=\footnotesize\ttfamily]
// Pomocnicze oznaczenia
GENDERS = 'male' | 'female' | 'other';
RATINGS = 'terrible' | 'poor' | 'fair' | 'good' | 'excellent';
SPORTS = 'touring' | 'mtb' | 'enduro' | 'downhill' | 'gravel' | 'road' | 'bmx' | 'tandem' | 'cyclocross' | 'track' | 'speedway' |'other';
CATEGORIES  = 'commute' | 'casual' | 'training' | 'race' | 'bikepacking' | 'other';

// W³aœciwa struktura
database_root: {
  <unique(userId)>?: {
    userId: string;
    profile?: {
      gender?: valueOf(GENDERS)
      birthday?: Date;
      weight?: number;
      height?: number;
      country?: string;
      city?: string;
      description?: string;
    }
    statistics?: {
      minDistance?: number;
      minElevation?: number;
      minDuration?: number;
      maxSpeed?: number;
      maxDistance?: number;
      maxElevation?: number;
      maxDuration?: number;
      totalDistance?: number;
      totalElevationUp?: number;
      totalElevationDown?: number;
      totalDuration?: number;
      totalInMotionDuration?: number;
      longestUphill?: number;
      longestDownhill?: number;
      firstActivityAt?: number;
      lastActivityAt?: number;
      ratingStatistics?: { <valueOf(RATINGS)>: number; };
      sportStatistics?: { <valueOf(SPORTS)>?: number; };
      categoryStatistics?: { <valueOf(CATEGORIES)>?: number; };
    };
    activities?:{
      <unique(activityId)>: {
        activityId: string;
        creatorId: string;
        name: string;
        createdAt: number;
        lastModifiedAt: number;
        sport?: valueOf(SPORTS);
        category?: valueOf(CATEGORIES);
        rating?: valueOf(RATINGS);
        tags?: string[];
        shape?: { isLoop: boolean; from: string; to: string; };
        statistics?: {
          totalDistance?: number;
          totalDuration?: number;
          inMotionDuration?: number;
          maxSpeed?: number;
          elevationUp?: number;
          elevationDown?: number;
        };
        track: (
            { lat: number; lon: number; time: number; ele?: number; }[]
        )[];
      }
    };
  };
};
\end{lstlisting}
}

Dostêp do zasobów bazy \texttt{Realtime} kontrolowany jest przez zasady (ang. \emph{database rules}). Ka¿de zapytanie odczytu lub zapisu do bazy przechodzi przez weryfikacjê, i jest wykonane tylko wtedy, gdy pozwol¹ na to zasady. Zasady maj¹ postaæ drzewa JSON. Przyk³ad pokazano na listingu~\ref{lst:databaserules} --- zasada udziela mo¿liwoœæ zapisywania do œcie¿ki \texttt{/users/<uid>/} tylko uwierzytelnionym u¿ytkownikom.

{\belowcaptionskip=-9pt
\begin{lstlisting}[ label=lst:databaserules, caption=Przyk³ad zasady definiuj¹cej dostêp do bazy danych,
    basicstyle=\footnotesize\ttfamily]
{
  "rules": {
    "users": {
      "$uid": {
        ".write": "$uid === auth.uid"
      }
    }
  }
}
\end{lstlisting}
}

\subsection{Hosting}
W zakresie us³ug \texttt{Firebase'a} jest równie¿ mo¿liwoœæ hostowania aplikacji. Us³uga ta jest wykorzystana w projekcie. Zbudowan¹ aplikacjê mo¿na opublikowaæ w bardzo prosty sposób z u¿yciem tylko jednej komendy. Aplikacje publikowane s¹ w dwóch domyœlnych domenach: \texttt{\emph{nazwa-aplikacji}.web.app} oraz \texttt{\emph{nazwa-aplikacji}.firebase.app}. Istnieje równie¿ mo¿liwoœæ konfiguracji w³asnej domeny.

Aplikacje hostowane s¹ w standardzie SSL, co pozwala na wykorzystanie protoko³u HTTPS. Jest to o tyle istotne, ¿e w przypadku braku protoko³u HTTPS przegl¹darki internetowe blokuj¹ dostêp do pewnych funkcjonalnoœci. W kontekœcie projektu ma to fundamentalne znaczenie, poniewa¿ jedn¹ z blokowanych funkcjonalnoœci jest lokalizacja GPS, na którym oparta jest ca³a koncepcja projektu.

\section{Warstwa frontend}
Aplikacjê klienta zaimplementowano z wykorzystaniem biblioteki \texttt{React} \cite{react} oraz jêzyka \texttt{TypeScript}. Jest to darmowa i otwarta biblioteka jêzyka \texttt{JavaScript}, która przeznaczona jest do budowania interfejsów u¿ytkownika aplikacji internetowych typu SPA (ang~\emph{Single-page Application}). SPA, jest to aplikacja jednostronicowa (posiada tylko jeden plik HTML), która dynamicznie aktualizuje swoj¹ zawartoœæ, zamiast dokonywaæ prze³adowania ca³ej strony. Aplikacje SPA zapewniaj¹ bardzo dobre doœwiadczenie u¿ytkownika (ang~\emph{user experience}) i wyznaczaj¹ standard tworzenia wspó³czesnych aplikacji internetowych. W zestawieniu z \texttt{Reactem} wykorzystano dodatkowe narzêdzia. Najwa¿niejsze z nich przedstawiono w tabeli~\ref{tab:biblioteki}

\begin{table}[htb] \small
  \centering
  \caption{Lista g³ównych modu³ów platformy Google Firebase}
  \label{tab:biblioteki}
  \begin{tabularx}{\linewidth}{|l|X|X|} \hline
    Nazwa                                     & Zastosowanie                                                                                                          & Link                                                                  \\      \hline\hline
    \texttt{TypeScript}                       & Jêzyk programowania oparty na \texttt{JavaScript}, dodaj¹cy do statyczne typowanie                                    & \url{typescriptlang.org}                                              \\      \hline
    \texttt{Less.js}                          & Rozszerzenie jêzykowe CSS, stylowanie aplikacji                                                                       & \url{lesscss.org}                                                     \\      \hline
    \texttt{React}                            & Budowa interfejsu u¿ytkownika                                                                                         & \url{reactjs.org}                                                     \\      \hline
    \texttt{Ant Design}                       & Gotowe komponenty reactowych oraz system designu                                                                      & \url{ant.design}                                                      \\      \hline
    \texttt{Firebase}                         & Integracja z platform¹ Firebase                                                                                       & \url{firebase.google.com}                                             \\      \hline
    \texttt{FirebaseUI}                       & Gotow¹ implementacja uwierzytelniania z platform¹ Firebase                                                            & \url{firebase.google.com}                                             \\      \hline
    \texttt{Leaflet}                          & Interaktywne mapy                                                                                                     & \url{leafletjs.com}                                                   \\      \hline
    \texttt{React-Leaflet}                    & Wrapper Leafleta, gotowe komponenty reactowe                                                                          & \url{react-leaflet.js.org}                                            \\      \hline
    \texttt{FileSaver.js}                     & Obs³uga zapisywania plików na dysku                                                                                   & \url{github.com/eligrey/FileSaver.js}                                 \\      \hline
    \texttt{react-vis}                        & Reactowe komponenty wykresów                                                                                          & \url{uber.github.io/react-vis/}                                       \\      \hline
    \texttt{react-icons}                      & Reactowe komponenty ikon                                                                                              & \url{react-icons.github.io/react-icons/}                              \\      \hline
    \texttt{react-resize-detector}            & API obserwacji zmiany rozmiaru elementów na stronie                                                                   & \url{github.com/maslianok/react-resize-detector}                      \\      \hline
    \texttt{react-responsive}                 & API obserwacji zmiany rozmiaru okna aplikacji                                                                         & \url{github.com/yocontra/react-responsive}                            \\      \hline
    \texttt{GPXParser}                        & Parser standardu GPX na obiekty javascriptowe                                                                         & \url{github.com/Luuka/GPXParser.js}                                   \\      \hline
    \texttt{GPX builder}                      & Parser obiektów javascriptowych na standard GPX                                                                       & \url{github.com/Luuka/GPXParser.js}                                   \\      \hline
    \texttt{nosleep.js}                       & Mechanizm blokady wygaszania ekranu urz¹dzenia                                                                        & \url{github.com/richtr/NoSleep.js}                                    \\      \hline
    \texttt{uuid}                             & Generator unikalnych identyfikatorów                                                                                  & \url{github.com/uuidjs/uuid}                                          \\      \hline
    \texttt{he}                               & Enkoder i dekoder \emph{html entities}                                                                                & \url{github.com/mathiasbynens/he}                                     \\      \hline
    \texttt{useTimeout}, \texttt{useInterval} & Hooki reactowe umo¿liwiaj¹ce deklaratywne u¿ycie javscriptowych funkcji \texttt{setTimeout} oraz \texttt{setInterval} & \url{overreacted.io/making-setinterval-declarative-with-react-hooks/} \\      \hline
  \end{tabularx}
\end{table}